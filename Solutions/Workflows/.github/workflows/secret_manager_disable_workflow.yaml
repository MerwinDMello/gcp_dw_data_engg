name: GCP Secret Disable workflow

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: "Environment to deploy to"
        required: true
      secret_id:
        description: "Name of the secret whose version will be disabled in GSM"
        required: true
        type: string
      project_id:
        type: string
        description: "Project where the secret exists"
        required: true
      version_id:
        type: string
        description: "The version of the secret to be disabled"
        required: true
    secrets:
      GH_TOKEN:
        description: "GitHub token to allow checking out workflow repository"
        required: true

jobs:
  Disable:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Secret Manager Disable Job
    permissions:
      contents: "read"
      id-token: "write"
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
    
      - name: Disable GCP Secret Version
        uses: HCACloudDataEngineering/gcp-hin-workflows/secret-manager/disable@main
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICEACCOUNT_GITHUB }}
          secret_id: ${{ inputs.secret_id }}
          project_id: ${{ inputs.project_id }}
          version_id: ${{ inputs.version_id }}
          token: ${{ secrets.GH_TOKEN }}

  Summary:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Disable Summary
    needs: [Disable]
    if: always()
    steps:
      - name: Reusable Workflow Summary
        run: |
          echo "# GCP Secret Disable Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ **Project ID** | \`${{ inputs.project_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”‘ **Secret ID** | \`${{ inputs.secret_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ **Version ID** | \`${{ inputs.version_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— **Workflow Run** | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.Disable.result }}" == "success" ]; then
            echo "âœ… **Status**: Secret version disabled successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Disable operation failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi