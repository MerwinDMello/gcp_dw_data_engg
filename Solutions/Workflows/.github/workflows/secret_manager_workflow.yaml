name: GCP Secret Deployment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: "Environment to deploy to"
        required: true
      secret_id:
        description: "Name of the secret to create or update in GSM"
        required: true
        type: string
      project_id:
        type: string
        description: "Project where the secret will be created or updated"
        required: true
      encrypt:
        type: string
        description: "Whether or not to add additional layer of encryption"
        required: true
      region:
        type: string
        description: "GCP region for KMS and Secret Manager resources"
        required: false
    secrets:
      GH_TOKEN:
        description: "GitHub token to allow checking out workflow repository"
        required: true
      key_prefix:
        description: "Beginning part of the secret key name, will default to 'hin-key' in the deploy job if not provided"
        required: false
      encryption_key:
        description: "Value at the end of the secret key name and keyring name used for encrypting the secret"
        required: true
      secret_data:
        description: "The secret value to assign to the secret in Secret Manager"
        required: true

jobs:
  Build:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Secret Manager Build Job
    permissions:
      contents: "read"
      id-token: "write"
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      # The build composite action checks out the workflow repo and collects the deploy.py script
      - name: Secret Manager Build
        uses: HCACloudDataEngineering/gcp-hin-workflows/secret-manager/build@main
        with:
          token: ${{ secrets.GH_TOKEN }}

  Deploy:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Secret Manager Deploy Job
    needs: [Build]
    environment: ${{ inputs.environment }}
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - uses: actions/checkout@v4
    
      - name: Deploy GCP-Secret Deploy
        uses: HCACloudDataEngineering/gcp-hin-workflows/secret-manager/deploy@main
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICEACCOUNT_GITHUB }}
          secret_id: ${{ inputs.secret_id }}
          project_id: ${{ inputs.project_id }}
          encrypt: ${{ inputs.encrypt }}
          region: ${{ inputs.region || 'us-east4' }}
          key_prefix: ${{ secrets.key_prefix }}
          encryption_key: ${{ secrets.encryption_key }}
          secret_data: ${{ secrets.secret_data }}

  Summary:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Deployment Summary
    needs: [Deploy]
    if: always()
    steps:
      - name: Reusable Workflow Summary
        run: |
          echo "# GCP Secret Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ **Project ID** | \`${{ inputs.project_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”‘ **Secret ID** | \`${{ inputs.secret_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ **Encryption** | \`${{ inputs.encrypt }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒŽ **Region** | \`${{ inputs.region || 'us-east4' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— **Workflow Run** | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.Deploy.result }}" == "success" ]; then
            echo "âœ… **Status**: Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Deployment failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
