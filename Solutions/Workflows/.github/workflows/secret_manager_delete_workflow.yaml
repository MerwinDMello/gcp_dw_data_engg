name: GCP Secret Delete Workflow

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: "Environment to deploy to"
        required: true
      secret_id:
        description: "Name of the secret to be deleted from GSM"
        required: true
        type: string
      project_id:
        type: string
        description: "Project where the secret exists"
        required: true
      version_id:
        type: string
        description: "The version of the secret to be deleted (optional - if not provided, entire secret will be deleted)"
        required: false
    secrets:
      GH_TOKEN:
        description: "GitHub token to allow checking out workflow repository"
        required: true

jobs:
  Delete:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Secret Manager Delete Job
    permissions:
      contents: "read"
      id-token: "write"
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
    
      - name: Delete GCP Secret
        uses: HCACloudDataEngineering/gcp-hin-workflows/secret-manager/delete@main
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICEACCOUNT_GITHUB }}
          secret_id: ${{ inputs.secret_id }}
          project_id: ${{ inputs.project_id }}
          version_id: ${{ inputs.version_id }}
          token: ${{ secrets.GH_TOKEN }}

  Summary:
    runs-on: [self-hosted, X64, enterprise, Linux, onprem-k8s-arc, lnx-amd64, std]
    name: Delete Summary
    needs: [Delete]
    if: always()
    steps:
      - name: Reusable Workflow Summary
        run: |
          echo "# GCP Secret Delete Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ **Environment** | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ **Project ID** | \`${{ inputs.project_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”‘ **Secret ID** | \`${{ inputs.secret_id }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.version_id }}" ]; then
            echo "| ðŸ“‹ **Version ID** | \`${{ inputs.version_id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ **Operation** | Delete specific version |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“‹ **Version ID** | \`(not specified)\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¯ **Operation** | Delete entire secret |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| ðŸ‘¤ **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— **Workflow Run** | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.Delete.result }}" == "success" ]; then
            if [ -n "${{ inputs.version_id }}" ]; then
              echo "âœ… **Status**: Secret version deleted successfully!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Status**: Entire secret deleted successfully!" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Delete operation failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi