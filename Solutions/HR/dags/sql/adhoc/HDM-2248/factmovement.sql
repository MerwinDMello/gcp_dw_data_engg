create table if not exists `{{ params.param_hr_core_dataset_name }}.fact_total_movement_2248`
(
  total_movement_sid INT64 NOT NULL OPTIONS(description="Unique sequence number generated by etl."),
  employee_sid INT64 NOT NULL OPTIONS(description="Unique numeric number generated for unique combination of Employee Identifier and HR Company Identifier"),
  date_id DATE NOT NULL OPTIONS(description="The date the metric was calculated for the given dimensions."),
  analytics_msr_sid INT64 NOT NULL OPTIONS(description="This is the system assigned number to uniquely identfiy a row in the hierarchy."),
  employee_num INT64 OPTIONS(description="This is an lawson employee number"),
  action_code STRING OPTIONS(description="Unique code value of an action"),
  action_reason_text STRING OPTIONS(description="Reason description of an action taken on employee"),
  movement_type STRING OPTIONS(description="This contains the movement type of employee like internal or external."),
  movement_direction_text STRING OPTIONS(description="This contains the movement direction of employee like promotion, demotion, lateral etc"),
  from_position_sid INT64 OPTIONS(description="Old value of position system identifier"),
  from_position_level_sequence_num INT64 OPTIONS(description="Old value to represent primary or secondary position of an employee"),
  from_fte_pct NUMERIC(7, 6) OPTIONS(description="Old value of full time equivalent percentage"),
  from_schedule_work_code STRING OPTIONS(description="Old value of schedule work"),
  from_working_location_code STRING OPTIONS(description="Old value of employee physical working location is maintained in this field"),
  from_dept_sid INT64 OPTIONS(description="Old value of unique number for each department code of Process level code associated with an HR Company Code."),
  from_lawson_company_num INT64 OPTIONS(description="Old value of lawson company number"),
  from_process_level_code STRING OPTIONS(description="Old value of process level code"),
  from_job_code_sid INT64 OPTIONS(description="Old value of  job code system identifier"),
  from_job_class_sid INT64 OPTIONS(description="Old value of job class system identifier"),
  from_coid STRING OPTIONS(description="Old value of company identifier which uniquely identifies a facility to corporate and all other facilities."),
  from_company_code STRING OPTIONS(description="Old value of company code"),
  from_sub_functional_dept_num INT64 OPTIONS(description="Old value of sub functional department number"),
  from_functional_dept_num INT64 OPTIONS(description="Old value of functional department number"),
  from_auxiliary_status_sid INT64 OPTIONS(description="Old value of auxiliary status system identifier"),
  from_employee_status_sid INT64 OPTIONS(description="Old value of employee system identifier"),
  from_pay_rate_amt NUMERIC(18, 3) OPTIONS(description="Old value of pay rate amount"),
  from_key_talent_id INT64 OPTIONS(description="It is the unique sequence number generated by ETL for each Job code and Facility level combination"),
  from_integrated_lob_id INT64 OPTIONS(description="This field captures ETL generated unique sequence number for each LOB description"),
  to_position_sid INT64 OPTIONS(description="New value of position system identifier"),
  to_position_level_sequence_num INT64 OPTIONS(description="New value to represent primary or secondary position of an employee"),
  to_fte_pct NUMERIC(7, 6) OPTIONS(description="New value of full time equivalent percentage"),
  to_schedule_work_code STRING OPTIONS(description="New value of schedule work code"),
  to_working_location_code STRING OPTIONS(description="New value of employee physical working location is maintained in this field"),
  to_dept_sid INT64 OPTIONS(description="New value of unique number for each department code of Process level code associated with an HR Company Code."),
  to_lawson_company_num INT64 OPTIONS(description="New value of lawson company number"),
  to_process_level_code STRING OPTIONS(description="New value of process level code"),
  to_job_code_sid INT64 OPTIONS(description="New value of  job code system identifier"),
  to_job_class_sid INT64 OPTIONS(description="New value of job class system identifier"),
  to_coid STRING OPTIONS(description="New value of company identifier which uniquely identifies a facility to corporate and all other facilities."),
  to_company_code STRING OPTIONS(description="New value of company code"),
  to_sub_functional_dept_num INT64 OPTIONS(description="New value of sub functional department number"),
  to_functional_dept_num INT64 OPTIONS(description="New value of functional department number"),
  to_auxiliary_status_sid INT64 OPTIONS(description="New value of auxiliary status system identifier"),
  to_employee_status_sid INT64 OPTIONS(description="New value of employee system identifier"),
  to_pay_rate_amt NUMERIC(18, 3) OPTIONS(description="New value of pay rate amount"),
  to_key_talent_id INT64 OPTIONS(description="It is the unique sequence number generated by ETL for each Job code and Facility level combination"),
  to_integrated_lob_id INT64 OPTIONS(description="This field captures ETL generated unique sequence number for each LOB description"),
  pay_change_diff_amt NUMERIC(18, 3) OPTIONS(description="Difference amount of pay change"),
  source_system_code STRING NOT NULL OPTIONS(description="A one character code indicating the specific source system from which the data originated."),
  dw_last_update_date_time DATETIME NOT NULL OPTIONS(description="Timestamp of update or load of this record to the Enterprise Data Warehouse.")
)
CLUSTER BY employee_sid
OPTIONS(
  description="This is the derived table to identify the movement of employees who switch positions within HCA during a specified time period. Total movement includes two sections: Internal Movement and External Movement. "
);

INSERT INTO `{{ params.param_hr_core_dataset_name }}.fact_total_movement_2248`
SELECT
    total_movement_sid,
    employee_sid,
    date_id,
    analytics_msr_sid,
    employee_num,
    action_code,
    action_reason_text,
    movement_type,
    movement_direction_text,
    from_position_sid,
    from_position_level_sequence_num,
    from_fte_pct,
    from_schedule_work_code,
    from_working_location_code,
    from_dept_sid,
    from_lawson_company_num,
    from_process_level_code,
    from_job_code_sid,
    from_job_class_sid,
    from_coid,
    from_company_code,
    from_sub_functional_dept_num,
    from_functional_dept_num,
    from_auxiliary_status_sid,
    from_employee_status_sid,
    from_pay_rate_amt,
    null as from_key_talent_id,
    null as from_integrated_lob_id,
    to_position_sid,
    to_position_level_sequence_num,
    to_fte_pct,
    to_schedule_work_code,
    to_working_location_code,
    to_dept_sid,
    to_lawson_company_num,
    to_process_level_code,
    to_job_code_sid,
    to_job_class_sid,
    to_coid,
    to_company_code,
    to_sub_functional_dept_num,
    to_functional_dept_num,
    to_auxiliary_status_sid,
    to_employee_status_sid,
    to_pay_rate_amt,
    null as to_key_talent_id,
    null as to_integrated_lob_id,
    pay_change_diff_amt,
    source_system_code,
    dw_last_update_date_time
  FROM
    {{ params.param_hr_core_dataset_name }}.fact_total_movement;

ALTER TABLE `{{ params.param_hr_core_dataset_name }}.fact_total_movement`
RENAME TO `fact_total_movement_pre_2248`;

ALTER TABLE `{{ params.param_hr_core_dataset_name }}.fact_total_movement_2248`
RENAME TO `fact_total_movement`;

create or replace view `{{ params.param_hr_base_views_dataset_name }}.fact_total_movement`
AS SELECT
    fact_total_movement.total_movement_sid,
    fact_total_movement.employee_sid,
    fact_total_movement.date_id,
    fact_total_movement.analytics_msr_sid,
    fact_total_movement.employee_num,
    fact_total_movement.action_code,
    fact_total_movement.action_reason_text,
    fact_total_movement.movement_type,
    fact_total_movement.movement_direction_text,
    fact_total_movement.from_position_sid,
    fact_total_movement.from_position_level_sequence_num,
    fact_total_movement.from_fte_pct,
    fact_total_movement.from_schedule_work_code,
    fact_total_movement.from_working_location_code,
    fact_total_movement.from_dept_sid,
    fact_total_movement.from_lawson_company_num,
    fact_total_movement.from_process_level_code,
    fact_total_movement.from_job_code_sid,
    fact_total_movement.from_job_class_sid,
    fact_total_movement.from_coid,
    fact_total_movement.from_company_code,
    fact_total_movement.from_sub_functional_dept_num,
    fact_total_movement.from_functional_dept_num,
    fact_total_movement.from_auxiliary_status_sid,
    fact_total_movement.from_employee_status_sid,
    fact_total_movement.from_pay_rate_amt,
    fact_total_movement.from_key_talent_id,
    fact_total_movement.from_integrated_lob_id,
    fact_total_movement.to_position_sid,
    fact_total_movement.to_position_level_sequence_num,
    fact_total_movement.to_fte_pct,
    fact_total_movement.to_schedule_work_code,
    fact_total_movement.to_working_location_code,
    fact_total_movement.to_dept_sid,
    fact_total_movement.to_lawson_company_num,
    fact_total_movement.to_process_level_code,
    fact_total_movement.to_job_code_sid,
    fact_total_movement.to_job_class_sid,
    fact_total_movement.to_coid,
    fact_total_movement.to_company_code,
    fact_total_movement.to_sub_functional_dept_num,
    fact_total_movement.to_functional_dept_num,
    fact_total_movement.to_auxiliary_status_sid,
    fact_total_movement.to_employee_status_sid,
    fact_total_movement.to_pay_rate_amt,
    fact_total_movement.to_key_talent_id,
    fact_total_movement.to_integrated_lob_id,
    fact_total_movement.pay_change_diff_amt,
    fact_total_movement.source_system_code,
    fact_total_movement.dw_last_update_date_time
  FROM
    {{ params.param_hr_core_dataset_name }}.fact_total_movement;

/***************************************************************************************
S E C U R I T Y   V I E W
****************************************************************************************/

  CREATE OR REPLACE VIEW {{ params.param_hr_views_dataset_name }}.fact_total_movement AS SELECT
      a.total_movement_sid,
      a.employee_sid,
      a.date_id,
      a.analytics_msr_sid,
      a.employee_num,
      a.action_code,
      a.action_reason_text,
      a.movement_type,
      a.movement_direction_text,
      a.from_position_sid,
      a.from_position_level_sequence_num,
      a.from_fte_pct,
      a.from_schedule_work_code,
      a.from_working_location_code,
      a.from_dept_sid,
      a.from_lawson_company_num,
      a.from_process_level_code,
      a.from_job_code_sid,
      a.from_job_class_sid,
      a.from_coid,
      a.from_company_code,
      a.from_sub_functional_dept_num,
      a.from_functional_dept_num,
      a.from_auxiliary_status_sid,
      a.from_employee_status_sid,
      a.from_pay_rate_amt,
      a.from_key_talent_id,
      a.from_integrated_lob_id,
      a.to_position_sid,
      a.to_position_level_sequence_num,
      a.to_fte_pct,
      a.to_schedule_work_code,
      a.to_working_location_code,
      a.to_dept_sid,
      a.to_lawson_company_num,
      a.to_process_level_code,
      a.to_job_code_sid,
      a.to_job_class_sid,
      a.to_coid,
      a.to_company_code,
      a.to_sub_functional_dept_num,
      a.to_functional_dept_num,
      a.to_auxiliary_status_sid,
      a.to_employee_status_sid,
      a.to_pay_rate_amt,
      a.to_key_talent_id,
      a.to_integrated_lob_id,
      a.pay_change_diff_amt,
      a.source_system_code,
      a.dw_last_update_date_time
    FROM
      {{ params.param_hr_base_views_dataset_name }}.fact_total_movement AS a
  ;

