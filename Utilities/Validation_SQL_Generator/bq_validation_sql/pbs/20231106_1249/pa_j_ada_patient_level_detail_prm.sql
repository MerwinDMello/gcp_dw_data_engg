##########################
## Variable Declaration ##
##########################

BEGIN

DECLARE srctableid, tolerance_percent, idx, idx_length INT64 DEFAULT 0;

DECLARE expected_value, actual_value, difference NUMERIC;

DECLARE sourcesysnm, srcdataset_id, srctablename, tgtdataset_id, tgttablename, audit_type, tableload_run_time, job_name, audit_status STRING;

DECLARE tableload_start_time, tableload_end_time, audit_time, current_ts DATETIME;

DECLARE exp_values_list, act_values_list ARRAY<STRING>;

SET current_ts = DATETIME_TRUNC(CURRENT_DATETIME('US/Central'), SECOND);

SET srctableid = Null;

SET sourcesysnm = ''; -- This needs to be added

SET srcdataset_id = (select arr[offset(1)] from (select split("{{ params.param_pbs_stage_dataset_name }}" , '.') as arr));

SET srctablename = concat(srcdataset_id, '.','' ); -- This needs to be added

SET tgtdataset_id = (select arr[offset(1)] from (select split("{{ params.param_pbs_core_dataset_name }}" , '.') as arr));

SET tgttablename =concat(tgtdataset_id, '.', @p_targettable_name);

SET tableload_start_time = @p_tableload_start_time;

SET tableload_end_time = @p_tableload_end_time;

SET tableload_run_time = CAST((tableload_end_time - tableload_start_time) AS STRING);

SET job_name = @p_job_name;

SET audit_time = current_ts;

SET tolerance_percent = 0;

SET exp_values_list =
(
SELECT SPLIT(SOURCE_STRING,',') values_list
FROM (SELECT concat(coalesce(trim(CAST(sum(src.ihch) AS STRING)), '0'), coalesce(trim(CAST(sum(src.insfc15) AS STRING)), '0'), coalesce(trim(CAST(sum(src.insfc99) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totuninsureddiscount) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalcharityexpansiondiscount) AS STRING)), '0'), coalesce(trim(CAST(sum(src.plp) AS STRING)), '0'), coalesce(trim(CAST(sum(src.total_discounts) AS STRING)), '0'), coalesce(trim(CAST(sum(src.secondaryagyuninsureddisc) AS STRING)), '0'), coalesce(trim(CAST(sum(src.secondaryagencycharityexpansiondiscount_ins) AS STRING)), '0'), coalesce(trim(CAST(sum(src.sec_plp) AS STRING)), '0'), coalesce(trim(CAST(sum(src.secondary_agency_discounts) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalnonsecondaryuninsureddiscount) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalnonsecondarycharityexpansiondiscount) AS STRING)), '0'), coalesce(trim(CAST(sum(src.total_nonsecondary_pat_liability_protection_discount) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalnonsecondarydiscounts) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalselfpayar) AS STRING)), '0'), coalesce(trim(CAST(sum(src.secondarytotacctbal) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalnonsecondaryselfpayar) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totalgrossnonsecondaryselfpayar) AS STRING)), '0'), coalesce(trim(CAST(sum(src.totpatientdue) AS STRING)), '0'), coalesce(trim(CAST(sum(src.dnfbsp) AS STRING)), '0'), coalesce(trim(CAST(sum(src.ihsp) AS STRING)), '0'), coalesce(trim(CAST(sum(src.dnfbch) AS STRING)), '0')) AS source_string
FROM
  (SELECT sum(CASE
                  WHEN peom.financial_class_code = 15
                       AND (upper(format_date('%Y%m', peom.discharge_date)) > upper(peom.rptg_period)
                            OR upper(peom.account_status_code) = 'UB'
                            AND peom.discharge_date IS NOT NULL
                            AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                            AND peom.total_account_balance_amt <> 0) THEN peom.total_account_balance_amt
                  ELSE CAST(0 AS NUMERIC)
              END) AS dnfbch, sum(CASE
                                      WHEN (upper(peom.account_status_code) = 'UB'
                                            AND upper(substr(peom.patient_type_code, 2, 1)) <> 'P'
                                            AND peom.discharge_date IS NULL
                                            AND peom.total_account_balance_amt <> 0
                                            OR upper(peom.account_status_code) = 'UB'
                                            AND upper(peom.unbill_pre_admit_ind) = 'Y')
                                           AND peom.financial_class_code = 15 THEN peom.total_account_balance_amt
                                      ELSE CAST(0 AS NUMERIC)
                                  END) AS ihch, sum(CASE
                                                        WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                             AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                             AND peom.payor_balance_amt_ins1 > 0
                                                             AND peom.financial_class_code_ins1 = 15 THEN peom.payor_balance_amt_ins1
                                                        ELSE CAST(0 AS NUMERIC)
                                                    END) + sum(CASE
                                                                   WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                        AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                        AND peom.payor_balance_amt_ins2 > 0
                                                                        AND peom.financial_class_code_ins2 = 15 THEN peom.payor_balance_amt_ins2
                                                                   ELSE CAST(0 AS NUMERIC)
                                                               END) + sum(CASE
                                                                              WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                   AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                   AND peom.payor_balance_amt_ins3 > 0
                                                                                   AND peom.financial_class_code_ins3 = 15 THEN peom.payor_balance_amt_ins3
                                                                              ELSE CAST(0 AS NUMERIC)
                                                                          END) AS insfc15, sum(CASE
                                                                                                   WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                        AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                        AND peom.payor_balance_amt_ins1 > 0
                                                                                                        AND peom.financial_class_code_ins1 = 99 THEN peom.payor_balance_amt_ins1
                                                                                                   ELSE CAST(0 AS NUMERIC)
                                                                                               END) + sum(CASE
                                                                                                              WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                   AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                   AND peom.payor_balance_amt_ins2 > 0
                                                                                                                   AND peom.financial_class_code_ins2 = 99 THEN peom.payor_balance_amt_ins2
                                                                                                              ELSE CAST(0 AS NUMERIC)
                                                                                                          END) + sum(CASE
                                                                                                                         WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                              AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                              AND peom.payor_balance_amt_ins3 > 0
                                                                                                                              AND peom.financial_class_code_ins3 = 99 THEN peom.payor_balance_amt_ins3
                                                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                                                     END) AS insfc99, sum(CASE
                                                                                                                                              WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                   AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                   AND peom.total_account_balance_amt > 0
                                                                                                                                                   AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                        AND peom.financial_class_code_ins1 = 99.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                              ELSE CAST(0 AS NUMERIC)
                                                                                                                                          END) + sum(CASE
                                                                                                                                                         WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                              AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                              AND peom.total_account_balance_amt > 0
                                                                                                                                                              AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                   AND peom.financial_class_code_ins2 = 99.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                                                                                     END) + sum(CASE
                                                                                                                                                                    WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                         AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                         AND peom.total_account_balance_amt > 0
                                                                                                                                                                         AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                              AND peom.financial_class_code_ins3 = 99.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                    ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                END) AS totuninsureddiscount, sum(CASE
                                                                                                                                                                                                      WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                           AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                           AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                           AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                AND peom.financial_class_code_ins1 = 15.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                      ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                  END) + sum(CASE
                                                                                                                                                                                                                 WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                      AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                      AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                      AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                           AND peom.financial_class_code_ins2 = 15.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                 ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                             END) + sum(CASE
                                                                                                                                                                                                                            WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                 AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                 AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                 AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                      AND peom.financial_class_code_ins3 = 15.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                            ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                        END) AS totalcharityexpansiondiscount, sum(ar_plp.ar_transaction_amt) AS plp, sum(CASE
                                                                                                                                                                                                                                                                                                              WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                   AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                   AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                   AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                        AND peom.financial_class_code_ins1 = 99.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                              ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                          END) + sum(CASE
                                                                                                                                                                                                                                                                                                                         WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                              AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                              AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                              AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                   AND peom.financial_class_code_ins2 = 99.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                     END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                    WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                         AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                         AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                         AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                              AND peom.financial_class_code_ins3 = 99.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                    ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                END) + (sum(CASE
                                                                                                                                                                                                                                                                                                                                                WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                     AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                     AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                     AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                          AND peom.financial_class_code_ins1 = 15.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                                                                ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                            END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                           WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                     AND peom.financial_class_code_ins2 = 15.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                                                           ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                       END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                      WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                           AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                           AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                           AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                AND peom.financial_class_code_ins3 = 15.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                                                      ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                  END)) + sum(ar_plp.ar_transaction_amt) AS total_discounts, coalesce(sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                              WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                   AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                   AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                   AND CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                   AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                   AND peom.financial_class_code_ins1 = 99.0 THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                                                                                                                                                              ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                          END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                         WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND peom.financial_class_code_ins2 = 99.0 THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                                                                                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                     END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND peom.financial_class_code_ins3 = 99.0 THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                END), NUMERIC '0.00') AS secondaryagyuninsureddisc, coalesce(sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND peom.financial_class_code_ins1 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND peom.financial_class_code_ins2 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     AND peom.financial_class_code_ins3 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       END), CAST(0 AS BIGNUMERIC)) AS secondaryagencycharityexpansiondiscount_ins, sum(ar_plp_sec.ar_transaction_amt) AS sec_plp, coalesce(sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND peom.financial_class_code_ins1 = 99.0 THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.financial_class_code_ins2 = 99.0 THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND peom.financial_class_code_ins3 = 99.0 THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      END), NUMERIC '0.00') + coalesce(sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         AND peom.financial_class_code_ins1 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.financial_class_code_ins2 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      END) + sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND peom.financial_class_code_ins3 = 15.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 END), CAST(0 AS BIGNUMERIC)) + sum(ar_plp_sec.ar_transaction_amt) AS secondary_agency_discounts, any_value(totalnonsecondaryuninsureddiscount) AS totalnonsecondaryuninsureddiscount, any_value(totalnonsecondarycharityexpansiondiscount) AS totalnonsecondarycharityexpansiondiscount, any_value(total_nonsecondary_pat_liability_protection_discount) AS total_nonsecondary_pat_liability_protection_discount, any_value(totalnonsecondarydiscounts) AS totalnonsecondarydiscounts, coalesce(sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND peom.total_account_balance_amt > 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              AND upper(peom.collector_org_type_code) = 'S' THEN peom.total_account_balance_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     END), NUMERIC '0.00') AS secondarytotacctbal, sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                AND peom.total_account_balance_amt > 0 THEN peom.patient_balance_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       END) AS totpatientdue, sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      WHEN (upper(format_date('%Y%m', peom.discharge_date)) > upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            OR upper(peom.account_status_code) = 'UB'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            AND peom.discharge_date IS NOT NULL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            AND peom.total_account_balance_amt <> 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           AND peom.financial_class_code = 99 THEN peom.total_account_balance_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END) AS dnfbsp, sum(CASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          WHEN peom.financial_class_code = 99
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               AND (upper(peom.account_status_code) = 'UB'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(substr(peom.patient_type_code, 2, 1)) <> 'P'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.discharge_date IS NULL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND peom.total_account_balance_amt <> 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    OR upper(peom.account_status_code) = 'UB'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AND upper(peom.unbill_pre_admit_ind) = 'Y') THEN peom.total_account_balance_amt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ELSE CAST(0 AS NUMERIC)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      END) AS ihsp, any_value(totalselfpayar) AS totalselfpayar, any_value(totalnonsecondaryselfpayar) AS totalnonsecondaryselfpayar, any_value(totalnonsecondaryselfpayar) + any_value(totalnonsecondarydiscounts) AS totalgrossnonsecondaryselfpayar
   FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom AS peom
   INNER JOIN
     (SELECT fd.*
      FROM {{ params.param_pbs_base_views_dataset_name }}.facility_dimension_eom AS fd
      FOR system_time AS OF timestamp(tableload_start_time, 'US/Central')
      WHERE upper(fd.summary_7_member_ind) = 'Y'
        AND upper(fd.company_code) = 'H'
      UNION ALL SELECT facility_dimension_eom.*
      FROM {{ params.param_pbs_base_views_dataset_name }}.facility_dimension_eom
      FOR system_time AS OF timestamp(tableload_start_time, 'US/Central')
      WHERE upper(facility_dimension_eom.coid) IN
          (SELECT DISTINCT upper(dim_esb_organization_homehealth_dnd.coid) AS coid
           FROM {{ params.param_pbs_stage_dataset_name }}.dim_esb_organization_homehealth_dnd
           WHERE dim_esb_organization_homehealth_dnd.coid IS NOT NULL ) ) AS f ON upper(f.unit_num) = upper(peom.unit_num)
   LEFT OUTER JOIN
     (SELECT max(k.coid) AS coid,
             k.pat_acct_num,
             sum(k.ar_transaction_amt) AS ar_transaction_amt
      FROM
        (SELECT max(a.coid) AS coid,
                a.pat_acct_num,
                sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0 ) AS pa ON upper(pa.coid) = upper(a.coid)
         AND pa.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND CAST(a.transaction_code AS FLOAT64) IN(784984.0,
                                                      784985.0)
           AND a.iplan_id IN(9929,
                             0)
         GROUP BY upper(a.coid),
                  2
         UNION ALL SELECT max(a.coid) AS coid,
                          a.pat_acct_num,
                          sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0 ) AS pa ON upper(pa.coid) = upper(a.coid)
         AND pa.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND CAST(a.transaction_code AS FLOAT64) IN(999999.0)
           AND a.iplan_id = 9929
         GROUP BY upper(a.coid),
                  2
         UNION ALL SELECT max(a.coid) AS coid,
                          a.pat_acct_num,
                          sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0 ) AS pa ON upper(pa.coid) = upper(a.coid)
         AND pa.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND a.iplan_id = 9929
           AND CAST(a.transaction_code AS FLOAT64) IN(920972.0,
                                                      920970.0,
                                                      920980.0,
                                                      920971.0,
                                                      920981.0,
                                                      920982.0)
         GROUP BY upper(a.coid),
                  2) AS k
      GROUP BY upper(k.coid),
               2) AS ar_plp ON upper(ar_plp.coid) = upper(peom.coid)
   AND ar_plp.pat_acct_num = peom.pat_acct_num
   LEFT OUTER JOIN
     (SELECT max(k1.coid) AS coid,
             k1.pat_acct_num,
             sum(k1.ar_transaction_amt) AS ar_transaction_amt
      FROM
        (SELECT max(a.coid) AS coid,
                a.pat_acct_num,
                sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0
              AND upper(pass_eom.collector_org_type_code) = 'S' ) AS pe ON upper(pe.coid) = upper(a.coid)
         AND pe.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND CAST(a.transaction_code AS FLOAT64) IN(784984.0,
                                                      784985.0)
           AND a.iplan_id IN(9929,
                             0)
         GROUP BY upper(a.coid),
                  2
         UNION ALL SELECT max(a.coid) AS coid,
                          a.pat_acct_num,
                          sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0
              AND upper(pass_eom.collector_org_type_code) = 'S' ) AS pe ON upper(pe.coid) = upper(a.coid)
         AND pe.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND CAST(a.transaction_code AS FLOAT64) IN(999999.0)
           AND a.iplan_id = 9929
         GROUP BY upper(a.coid),
                  2
         UNION ALL SELECT max(a.coid) AS coid,
                          a.pat_acct_num,
                          sum(a.ar_transaction_amt) AS ar_transaction_amt
         FROM {{ params.param_auth_base_views_dataset_name }}.ar_transaction_mv AS a
         INNER JOIN
           (SELECT pass_eom.*
            FROM {{ params.param_auth_base_views_dataset_name }}.pass_eom
            WHERE upper(pass_eom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
              AND pass_eom.total_account_balance_amt > 0
              AND upper(pass_eom.collector_org_type_code) = 'S' ) AS pe ON upper(pe.coid) = upper(a.coid)
         AND pe.pat_acct_num = a.pat_acct_num
         WHERE upper(a.transaction_type_code) IN('4',
                                                 '5')
           AND a.iplan_id = 9929
           AND CAST(a.transaction_code AS FLOAT64) IN(920972.0,
                                                      920970.0,
                                                      920980.0,
                                                      920971.0,
                                                      920981.0,
                                                      920982.0)
         GROUP BY upper(a.coid),
                  2) AS k1
      GROUP BY upper(k1.coid),
               2) AS ar_plp_sec ON upper(ar_plp_sec.coid) = upper(peom.coid)
   AND ar_plp_sec.pat_acct_num = peom.pat_acct_num
   CROSS JOIN UNNEST(ARRAY[ coalesce(sum(CASE
                                             WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA')
                                                  AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                  AND peom.total_account_balance_amt > 0 THEN peom.patient_balance_amt
                                             ELSE CAST(0 AS NUMERIC)
                                         END) + sum(CASE
                                                        WHEN (upper(format_date('%Y%m', peom.discharge_date)) > upper(peom.rptg_period)
                                                              OR upper(peom.account_status_code) = 'UB'
                                                              AND peom.discharge_date IS NOT NULL
                                                              AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                              AND peom.total_account_balance_amt <> 0)
                                                             AND peom.financial_class_code = 99 THEN peom.total_account_balance_amt
                                                        ELSE CAST(0 AS NUMERIC)
                                                    END) + sum(CASE
                                                                   WHEN peom.financial_class_code = 99
                                                                        AND (upper(peom.account_status_code) = 'UB'
                                                                             AND upper(substr(peom.patient_type_code, 2, 1)) <> 'P'
                                                                             AND peom.discharge_date IS NULL
                                                                             AND peom.total_account_balance_amt <> 0
                                                                             OR upper(peom.account_status_code) = 'UB'
                                                                             AND upper(peom.unbill_pre_admit_ind) = 'Y') THEN peom.total_account_balance_amt
                                                                   ELSE CAST(0 AS NUMERIC)
                                                               END) + sum(CASE
                                                                              WHEN peom.financial_class_code = 15
                                                                                   AND (upper(format_date('%Y%m', peom.discharge_date)) > upper(peom.rptg_period)
                                                                                        OR upper(peom.account_status_code) = 'UB'
                                                                                        AND peom.discharge_date IS NOT NULL
                                                                                        AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                        AND peom.total_account_balance_amt <> 0) THEN peom.total_account_balance_amt
                                                                              ELSE CAST(0 AS NUMERIC)
                                                                          END) + sum(CASE
                                                                                         WHEN (upper(peom.account_status_code) = 'UB'
                                                                                               AND upper(substr(peom.patient_type_code, 2, 1)) <> 'P'
                                                                                               AND peom.discharge_date IS NULL
                                                                                               AND peom.total_account_balance_amt <> 0
                                                                                               OR upper(peom.account_status_code) = 'UB'
                                                                                               AND upper(peom.unbill_pre_admit_ind) = 'Y')
                                                                                              AND peom.financial_class_code = 15 THEN peom.total_account_balance_amt
                                                                                         ELSE CAST(0 AS NUMERIC)
                                                                                     END) + (sum(CASE
                                                                                                     WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                          AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                          AND peom.payor_balance_amt_ins1 > 0
                                                                                                          AND peom.financial_class_code_ins1 = 15 THEN peom.payor_balance_amt_ins1
                                                                                                     ELSE CAST(0 AS NUMERIC)
                                                                                                 END) + sum(CASE
                                                                                                                WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                     AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                     AND peom.payor_balance_amt_ins2 > 0
                                                                                                                     AND peom.financial_class_code_ins2 = 15 THEN peom.payor_balance_amt_ins2
                                                                                                                ELSE CAST(0 AS NUMERIC)
                                                                                                            END) + sum(CASE
                                                                                                                           WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                                AND peom.payor_balance_amt_ins3 > 0
                                                                                                                                AND peom.financial_class_code_ins3 = 15 THEN peom.payor_balance_amt_ins3
                                                                                                                           ELSE CAST(0 AS NUMERIC)
                                                                                                                       END)) + (sum(CASE
                                                                                                                                        WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                             AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                                             AND peom.payor_balance_amt_ins1 > 0
                                                                                                                                             AND peom.financial_class_code_ins1 = 99 THEN peom.payor_balance_amt_ins1
                                                                                                                                        ELSE CAST(0 AS NUMERIC)
                                                                                                                                    END) + sum(CASE
                                                                                                                                                   WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                        AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                                                        AND peom.payor_balance_amt_ins2 > 0
                                                                                                                                                        AND peom.financial_class_code_ins2 = 99 THEN peom.payor_balance_amt_ins2
                                                                                                                                                   ELSE CAST(0 AS NUMERIC)
                                                                                                                                               END) + sum(CASE
                                                                                                                                                              WHEN upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                                                                   AND upper(peom.account_status_code) NOT IN('UB', 'BD')
                                                                                                                                                                   AND peom.payor_balance_amt_ins3 > 0
                                                                                                                                                                   AND peom.financial_class_code_ins3 = 99 THEN peom.payor_balance_amt_ins3
                                                                                                                                                              ELSE CAST(0 AS NUMERIC)
                                                                                                                                                          END)), NUMERIC '0.00') ]) AS totalselfpayar
   CROSS JOIN UNNEST(ARRAY[ coalesce(totalselfpayar - coalesce(sum(CASE
                                                                       WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA')
                                                                            AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                            AND peom.total_account_balance_amt > 0
                                                                            AND upper(peom.collector_org_type_code) = 'S' THEN peom.total_account_balance_amt
                                                                       ELSE CAST(0 AS NUMERIC)
                                                                   END), NUMERIC '0.00'), NUMERIC '0.00') ]) AS totalnonsecondaryselfpayar
   CROSS JOIN UNNEST(ARRAY[ coalesce(sum(ar_plp.ar_transaction_amt) - sum(ar_plp_sec.ar_transaction_amt), NUMERIC '0.00') ]) AS total_nonsecondary_pat_liability_protection_discount
   CROSS JOIN UNNEST(ARRAY[ coalesce(sum(CASE
                                             WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                  AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                  AND peom.total_account_balance_amt > 0
                                                  AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                       AND peom.financial_class_code_ins1 = 15.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                             ELSE CAST(0 AS NUMERIC)
                                         END) + sum(CASE
                                                        WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                             AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                             AND peom.total_account_balance_amt > 0
                                                             AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                  AND peom.financial_class_code_ins2 = 15.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                        ELSE CAST(0 AS NUMERIC)
                                                    END) + sum(CASE
                                                                   WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                        AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                        AND peom.total_account_balance_amt > 0
                                                                        AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                             AND peom.financial_class_code_ins3 = 15.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                   ELSE CAST(0 AS NUMERIC)
                                                               END) - coalesce(sum(CASE
                                                                                       WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                            AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                            AND peom.total_account_balance_amt > 0
                                                                                            AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9927.0)
                                                                                                 AND peom.financial_class_code_ins1 = 15.0)
                                                                                            AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                       ELSE CAST(0 AS NUMERIC)
                                                                                   END) + sum(CASE
                                                                                                  WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                       AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                       AND peom.total_account_balance_amt > 0
                                                                                                       AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9927.0)
                                                                                                            AND peom.financial_class_code_ins2 = 15.0)
                                                                                                       AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                  ELSE CAST(0 AS NUMERIC)
                                                                                              END) + sum(CASE
                                                                                                             WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                  AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                  AND peom.total_account_balance_amt > 0
                                                                                                                  AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9927.0)
                                                                                                                       AND peom.financial_class_code_ins3 = 15.0)
                                                                                                                  AND upper(peom.collector_org_type_code) = 'S' THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                             ELSE CAST(0 AS NUMERIC)
                                                                                                         END), CAST(0 AS BIGNUMERIC)), NUMERIC '0.00') ]) AS totalnonsecondarycharityexpansiondiscount
   CROSS JOIN UNNEST(ARRAY[ coalesce(sum(CASE
                                             WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                  AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                  AND peom.total_account_balance_amt > 0
                                                  AND (CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                       AND peom.financial_class_code_ins1 = 99.0) THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                             ELSE CAST(0 AS NUMERIC)
                                         END) + sum(CASE
                                                        WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                             AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                             AND peom.total_account_balance_amt > 0
                                                             AND (CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                  AND peom.financial_class_code_ins2 = 99.0) THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                        ELSE CAST(0 AS NUMERIC)
                                                    END) + sum(CASE
                                                                   WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                        AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                        AND peom.total_account_balance_amt > 0
                                                                        AND (CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                             AND peom.financial_class_code_ins3 = 99.0) THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                   ELSE CAST(0 AS NUMERIC)
                                                               END) - coalesce(sum(CASE
                                                                                       WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                            AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                            AND peom.total_account_balance_amt > 0
                                                                                            AND CAST(peom.iplan_id_ins1 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                            AND upper(peom.collector_org_type_code) = 'S'
                                                                                            AND peom.financial_class_code_ins1 = 99.0 THEN peom.payor_contract_allow_amt_ins1 + peom.payor_adjustment_amt_ins1
                                                                                       ELSE CAST(0 AS NUMERIC)
                                                                                   END) + sum(CASE
                                                                                                  WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                       AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                       AND peom.total_account_balance_amt > 0
                                                                                                       AND CAST(peom.iplan_id_ins2 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                       AND upper(peom.collector_org_type_code) = 'S'
                                                                                                       AND peom.financial_class_code_ins2 = 99.0 THEN peom.payor_contract_allow_amt_ins2 + peom.payor_adjustment_amt_ins2
                                                                                                  ELSE CAST(0 AS NUMERIC)
                                                                                              END) + sum(CASE
                                                                                                             WHEN upper(peom.account_status_code) IN('AR', 'AX', 'CA', 'UB')
                                                                                                                  AND upper(format_date('%Y%m', peom.discharge_date)) <= upper(peom.rptg_period)
                                                                                                                  AND peom.total_account_balance_amt > 0
                                                                                                                  AND CAST(peom.iplan_id_ins3 AS FLOAT64) IN(9940.0, 9941.0, 9942.0, 9943.0, 9944.0, 9945.0, 9946.0, 9947.0, 9948.0, 9949.0)
                                                                                                                  AND upper(peom.collector_org_type_code) = 'S'
                                                                                                                  AND peom.financial_class_code_ins3 = 99.0 THEN peom.payor_contract_allow_amt_ins3 + peom.payor_adjustment_amt_ins3
                                                                                                             ELSE CAST(0 AS NUMERIC)
                                                                                                         END), NUMERIC '0.00'), NUMERIC '0.00') ]) AS totalnonsecondaryuninsureddiscount
   CROSS JOIN UNNEST(ARRAY[ totalnonsecondaryuninsureddiscount + totalnonsecondarycharityexpansiondiscount + total_nonsecondary_pat_liability_protection_discount ]) AS totalnonsecondarydiscounts
   WHERE upper(peom.rptg_period) = upper(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)))
     AND left(peom.patient_type_code, 1) IN('O',
                                            'E',
                                            'S',
                                            'I') ) AS src ;

)
);

SET act_values_list =
(
SELECT SPLIT(SOURCE_STRING,',') values_list
FROM (SELECT concat(coalesce(trim(CAST(sum(x.inhouse_charity_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.insured_charity_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.insured_self_pay_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.uninsured_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.charity_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.patient_liab_prot_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.total_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.secn_agcy_unins_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.secn_agcy_charity_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.secn_agcy_pat_liab_prot_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.total_secn_agcy_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.non_secn_unins_disc_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.non_secn_charity_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.non_secn_patient_liab_prot_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.total_non_secn_discount_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.self_pay_ar_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.secn_agcy_acct_bal_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.non_secn_self_pay_ar_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.gross_non_secn_self_pay_ar_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.total_patient_due_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.discharged_not_final_bill_self_pay_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.inhouse_self_pay_amt) AS STRING)), '0'), coalesce(trim(CAST(sum(x.discharged_not_final_bill_charity_amt) AS STRING)), '0')) AS source_string
FROM {{ params.param_pbs_core_dataset_name }}.ada_patient_level_detail AS x
WHERE x.month_id = CASE format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH))
                       WHEN '' THEN 0.0
                       ELSE CAST(format_date('%Y%m', date_add(current_date('US/Central'), interval -1 MONTH)) AS FLOAT64)
                   END ;)
);

SET idx_length = (SELECT ARRAY_LENGTH(act_values_list));

LOOP
  SET idx = idx + 1;

  IF idx > idx_length THEN
    BREAK;
  END IF;

  SET expected_value = CAST(exp_values_list[ORDINAL(idx)] AS NUMERIC);
  SET actual_value = CAST(act_values_list[ORDINAL(idx)] AS NUMERIC);

  SET difference = 
    CASE 
    WHEN expected_value <> 0 Then CAST(((ABS(actual_value - expected_value)/expected_value) * 100) AS INT64)
    WHEN expected_value = 0 and actual_value = 0 Then 0
    ELSE actual_value
    END;

  SET audit_status = 
  CASE
    WHEN difference <= tolerance_percent THEN "PASS"
    ELSE "FAIL"
  END;

  IF idx = 1 THEN
    SET audit_type = "RECORD_COUNT";
  ELSE
    SET audit_type = CONCAT("VALIDATION_CNTRLID_",idx);
  END IF;

  --Insert statement
  INSERT INTO "{{ params.param_pbs_audit_dataset_name }}".audit_control
  VALUES
  (GENERATE_UUID(), cast(srctableid as int64), sourcesysnm, srctablename, tgttablename, audit_type,
  expected_value, actual_value, cast(tableload_start_time as datetime), cast(tableload_end_time AS datetime),
  tableload_run_time, job_name, audit_time, audit_status
   );

END LOOP;
