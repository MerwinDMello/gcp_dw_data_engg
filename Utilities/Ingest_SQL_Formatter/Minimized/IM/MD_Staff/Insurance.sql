SELECT row_number() OVER ( PARTITION BY 1 ORDER BY t1.providerid, t1.carriername, t1.expireddate DESC ) AS md_staff_provider_ins_id, t1.providerid AS md_staff_provider_id, t2.firstname AS md_staff_first_name, t2.middlename AS md_staff_middle_name, t2.[name] AS md_staff_full_name, t2.suffix AS md_staff_suffix_name, t1.expireddate AS md_staff_expired_date, t2.formalname AS md_staff_formal_name_txt, CAST((CASE WHEN LTRIM(RTRIM(isnull(t2.formalname, ''))) <> '' AND LTRIM(RTRIM(isnull(t2.degree, ''))) <> '' THEN concat(LTRIM(RTRIM(isnull(t2.formalname, ''))), ', ', LTRIM(RTRIM(isnull(t2.degree, ''))) ) ELSE formalname END) AS VARCHAR(255)) AS md_staff_professional_name, t1.issueddate AS md_staff_issued_date, t2.namewithdegree AS md_staff_name_with_degree_txt, t1.policynumber AS md_staff_policy_number, t1.retrodate AS md_staff_retroactive_date, t2.downloaddate AS md_staff_download_date, t1.carriername AS md_staff_ins_carr_name, t1.carrieraddress AS md_staff_ins_carr_addr_txt_1, t1.carrieraddress2 AS md_staff_ins_carr_addr_txt_2, t1.carriercity AS md_staff_ins_carr_city_name, t1.carrierstate AS md_staff_ins_carr_state_code, t1.carrierzip AS md_staff_ins_carr_zip_code, t1.carriertelephone AS md_staff_ins_carr_phone_num, t1.terms AS md_staff_ins_terms_desc, t1.[coverage] AS md_staff_ins_cov_desc, t2.department AS md_staff_dept_desc, 'S' AS source_system_code, 'v_currtimestamp' AS dw_last_update_date_time FROM ( SELECT DISTINCT CAST([providerid] AS VARCHAR(255)) AS [providerid], CAST([expireddate] AS DATE) AS expireddate, CAST([issueddate] AS DATE) AS issueddate, CAST([policynumber] AS VARCHAR(255)) AS policynumber, CAST([retrodate] AS DATE) AS retrodate, CAST([carriername] AS VARCHAR(255)) AS [carriername], CAST([carrieraddress] AS VARCHAR(255)) AS [carrieraddress], CAST([carrieraddress2] AS VARCHAR(255)) AS [carrieraddress2], CAST(carriercity AS VARCHAR(255)) AS carriercity, CAST(carrierstate AS VARCHAR(255)) AS carrierstate, CAST(carrierzip AS VARCHAR(255)) AS carrierzip, CAST(carriertelephone AS VARCHAR(255)) AS carriertelephone, LTRIM(RTRIM(CAST([terms] AS VARCHAR(255)))) AS terms, CAST([coverage] AS VARCHAR(255)) AS coverage FROM [md-staff_import].mdstaff.insurancedata WITH (nolock) WHERE providerid IS NOT NULL AND carriername IS NOT NULL ) t1 INNER JOIN ( SELECT CAST(providerid AS VARCHAR(50)) AS providerid, CAST(firstname AS VARCHAR(255)) AS firstname, CAST(middlename AS VARCHAR(255)) AS middlename, CAST(lastname AS VARCHAR(255)) AS lastname, CAST(suffix AS VARCHAR(255)) AS suffix, CAST(degree AS VARCHAR(255)) AS degree, CAST([name] AS VARCHAR(255)) AS [name], CAST(namewithdegree AS VARCHAR(255)) AS namewithdegree, CAST((CASE WHEN isnull(firstname, '') <> '' AND isnull(lastname, '') <> '' THEN concat(isnull(firstname, ''), (CASE WHEN LEN(REPLACE(LTRIM(RTRIM(isnull(middlename, ''))), '.', '')) > 0 THEN (CASE WHEN LEN(LTRIM(RTRIM(isnull(middlename, '')))) = 2 AND LTRIM(RTRIM(isnull(middlename, ''))) LIKE '%[A-Z]%.' THEN concat(' ', LTRIM(RTRIM(isnull(middlename, '')))) ELSE concat(' ', SUBSTRING(LTRIM(RTRIM(isnull(middlename, ''))), 1, 1), '.') END) ELSE '' END), ' ', isnull(lastname, ''), (CASE WHEN LTRIM(RTRIM(isnull(suffix, ''))) <> '' THEN concat(' ', LTRIM(RTRIM(isnull(suffix, '')))) ELSE '' END) ) ELSE '' END) AS VARCHAR(255)) AS formalname, CAST(department1 AS VARCHAR(255)) AS department, CAST(downloaddate AS DATETIME) AS downloaddate, row_number() OVER ( PARTITION BY CAST(providerid AS VARCHAR(50)) ORDER BY isnull(archived, '') ASC, (CASE WHEN LTRIM(RTRIM(isnull([primary facility], ''))) <> '' THEN 1 ELSE 2 END) ASC ) AS RowNum FROM [mdstaff].dbo.vw_providerdata WITH (nolock) ) t2 ON t1.providerid = t2.providerid AND t2.rownum = 1