SELECT contactid AS patient_contact_id, patientid AS cr_patient_id, relation AS contact_relation_id, TYPE AS contact_type_id, contactcode AS contact_num_code, TRIM(cntfirstname) AS contact_first_name, TRIM(cntlastname) AS contact_last_name, TRIM(cntmiddlename) AS contact_middle_name, remarks AS preferred_contact_method_text, 'M' AS source_system_code, 'v_currtimestamp' AS dw_last_update_date_time FROM ( SELECT c.contactid, patientid, relation, TYPE, contactcode, cntfirstname, cntlastname, cntmiddlename, remarks FROM mregistry.dbo.contacts c INNER JOIN ( SELECT contactid, count(*) cnt FROM mregistry.dbo.contacts GROUP BY contactid HAVING count(*)= 1 ) a ON c.contactid = a.contactid UNION ALL SELECT contactid, patientid, relation, TYPE, contactcode, cntfirstname, cntlastname, cntmiddlename, remarks FROM ( SELECT *, row_number() over( PARTITION BY contactid ORDER BY contactshospid DESC ) rn FROM mregistry.dbo.contacts WHERE contactid IN ( SELECT c.contactid FROM mregistry.dbo.contacts c INNER JOIN ( SELECT contactid, count(*) cnt FROM mregistry.dbo.contacts GROUP BY contactid HAVING count(*)> 1 ) a ON c.contactid = a.contactid INNER JOIN mregistry.dbo.contacts c1 ON c.contactid = c1.contactid AND c1.contactshospid IS NULL ) ) b WHERE b.rn = 1 ) c